# download coverage artifact
# upload to code climate
# update github pages if everything passed

name: Coverage
on:
  workflow_run:
    workflows: ["Test"]
    types: 
      - completed

# permissions:
#   # down scope as necessary via https://docs.github.com/en/actions/reference/authentication-in-a-workflow#modifying-the-permissions-for-the-github_token

jobs:
  upload_coverage:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
    - env:
        GITHUB: ${{ toJson(github) }}
        ENV: ${{ toJson(env) }}
        JOB: ${{ toJson(job) }}
        STEPS: ${{ toJson(steps) }}
        RUNNER: ${{ toJson(runner) }}
        SECRETS: ${{ toJson(secrets) }}
        STRATEGY: ${{ toJson(strategy) }}
        MATRIX: ${{ toJson(matrix) }}
        NEEDS: ${{ toJson(needs) }}
      run: |
        env
    - name: Download coverage
      uses: dawidd6/action-download-artifact@v2
      with:
        # Required, workflow file name or ID
        workflow: test.yml
        # Optional, the status or conclusion of a completed workflow to search for
        # Can be one of a workflow conclusion::
        # "failure", "success", "neutral", "cancelled", "skipped", "timed_out", "action_required"
        # Or a workflow status:
        # "completed", "in_progress", "queued"
        # Default: "completed,success"
        # workflow_conclusion: success

        commit: ${{github.event.workflow_run.head_sha}}
        run_id: ${{ github.event.workflow_run.id }}
        run_number: ${{ github.event.workflow_run.run_number }}
        name: rspec-coverage
        path: ./coverage
    - run: ls -la ./coverage


    # - name: Report to codeclimate
    #   if: always()
    #   shell: bash
    #   env:
    #     JOB_STATUS: ${{ job.status == 'Success' }}
    #     CC_TEST_REPORTER_ID: ${{ secrets.CC_TEST_REPORTER_ID }}
    #   run: |
    #     EXIT_CODE=$([[ "$JOB_STATUS" == true ]] && echo 0 || echo 1)
    #     ./cc-test-reporter after-build --exit-code $EXIT_CODE

    # - name: Upload coverage to GitHub pages
    #   uses: maxheld83/ghpages@v0.2.1
    #   env:
    #     BUILD_DIR: ./coverage
    #     GH_PAT: ${{ secrets.GH_PAT }}
